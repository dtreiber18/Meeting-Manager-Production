<!-- Modal Container -->
<app-modal-container></app-modal-container>

<!-- Loading State -->
<div *ngIf="loading" class="loading-container flex items-center justify-center min-h-screen">
  <div class="text-center">
    <div class="loading-spinner animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
    <p class="text-gray-600">Loading meeting details...</p>
  </div>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="error-container flex items-center justify-center min-h-screen">
  <div class="text-center bg-red-50 border border-red-200 rounded-lg p-8 max-w-md">
    <div class="text-red-500 text-4xl mb-4">‚ö†Ô∏è</div>
    <h3 class="text-lg font-semibold text-red-800 mb-2">Unable to Load Meeting</h3>
    <p class="text-red-700 mb-4">{{ error }}</p>
    <button 
      (click)="retryLoad()"
      class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
      Try Again
    </button>
  </div>
</div>

<!-- Meeting Details Content -->
<div *ngIf="meeting && !loading" class="min-h-screen bg-gray-50">
  <!-- Breadcrumb Navigation -->
  <nav class="bg-white border-b border-gray-200 px-6 py-3">
    <ol class="flex items-center space-x-2 text-sm text-gray-500 max-w-7xl mx-auto">
      <li><a href="/meetings" class="hover:text-blue-600 transition-colors">Meetings</a></li>
      <li><span class="mx-2">/</span></li>
      <li class="text-gray-900 font-medium truncate">{{ editedMeeting.title }}</li>
    </ol>
  </nav>

  <!-- Main Layout -->
  <div class="max-w-7xl mx-auto px-6 py-6">
    <div class="flex flex-col md:flex-row gap-6">
      <!-- Main Content Column (2/3 width) -->
      <div class="flex-1 md:w-2/3 space-y-4">
      
        <!-- Meeting Header Card -->
        <div class="bg-white rounded-lg shadow-sm border transition-all duration-200"
             [ngClass]="isEditing ? 'border-blue-400 ring-2 ring-blue-100' : 'border-gray-200'">
          <!-- Card Header -->
          <div class="flex items-center justify-between p-4 border-b"
               [ngClass]="isEditing ? 'border-blue-300 bg-blue-50/50' : 'border-gray-200'">
            <h3 class="text-base font-semibold text-gray-900">Meeting Details</h3>
            <div class="flex items-center space-x-2">
              <!-- Collapse/Expand button -->
              <button 
                type="button"
                (click)="toggleCardCollapse('header')"
                class="p-1 text-gray-400 hover:text-gray-600 transition-colors">
                <mat-icon class="w-4 h-4">{{ cardState.header.collapsed ? 'expand_more' : 'expand_less' }}</mat-icon>
              </button>
              <!-- Global Edit/Save/Cancel buttons (only on header card) -->
              <div class="flex items-center space-x-2">
                <!-- Edit button (shown when NOT editing) -->
                <button
                  *ngIf="!isEditing"
                  type="button"
                  (click)="enterEditMode(); $event.preventDefault(); $event.stopPropagation()"
                  class="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center space-x-1">
                  <mat-icon class="w-4 h-4">edit</mat-icon>
                  <span>Edit</span>
                </button>

                <!-- Save button (shown when editing) -->
                <button
                  *ngIf="isEditing"
                  type="button"
                  (click)="saveAllChanges(); $event.preventDefault(); $event.stopPropagation()"
                  class="px-3 py-1 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors flex items-center space-x-1">
                  <mat-icon class="w-4 h-4">save</mat-icon>
                  <span>Save</span>
                </button>

                <!-- Cancel button (shown when editing) -->
                <button
                  *ngIf="isEditing"
                  type="button"
                  (click)="cancelEditMode(); $event.preventDefault(); $event.stopPropagation()"
                  class="px-3 py-1 text-sm bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors flex items-center space-x-1">
                  <mat-icon class="w-4 h-4">close</mat-icon>
                  <span>Cancel</span>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Card Content -->
          <div class="p-4" [hidden]="cardState.header.collapsed">
            <!-- Read-only view -->
            <div *ngIf="!cardState.header.editing">
              <h1 class="text-xl font-semibold text-gray-900 mb-2">{{ editedMeeting.title }}</h1>
              <div class="flex items-center space-x-4 text-sm text-gray-600 flex-wrap">
                <!-- Source Badge -->
                <span *ngIf="meeting.source === 'fathom'"
                      class="inline-flex items-center px-3 py-1 rounded-full bg-indigo-100 text-indigo-800 border border-indigo-300 text-xs font-medium">
                  üé§ Imported from Fathom
                </span>
                <span *ngIf="meeting.source === 'n8n'"
                      class="inline-flex items-center px-3 py-1 rounded-full bg-purple-100 text-purple-800 border border-purple-300 text-xs font-medium">
                  üîÑ From N8N
                </span>

                <span class="flex items-center">
                  <mat-icon class="w-4 h-4 mr-1">event</mat-icon>
                  {{ editedMeeting.startTime | date:'M/d/yy, h:mm a' }}
                </span>
                <span class="flex items-center">
                  <mat-icon class="w-4 h-4 mr-1">schedule</mat-icon>
                  {{ editedMeeting.startTime | date:'shortTime' }}
                </span>
                <span class="flex items-center">
                  <mat-icon class="w-4 h-4 mr-1">group</mat-icon>
                  {{ allParticipants.length }} participants
                </span>
              </div>
            </div>
            
            <!-- Edit view -->
            <div *ngIf="cardState.header.editing" class="space-y-4">
              <div>
                <label for="meeting-title" class="block text-sm font-medium text-gray-700 mb-1">Meeting Title</label>
                <input 
                  id="meeting-title"
                  type="text" 
                  [(ngModel)]="editedMeeting.title"
                  placeholder="Enter meeting title"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="meeting-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                  <input 
                    id="meeting-start-date"
                    type="datetime-local" 
                    [ngModel]="editedMeeting.startTime | date:'yyyy-MM-ddTHH:mm'"
                    (ngModelChange)="editedMeeting.startTime = $event"
                    title="Set meeting start date and time"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                  <label for="meeting-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                  <input 
                    id="meeting-end-date"
                    type="datetime-local" 
                    [ngModel]="editedMeeting.endTime | date:'yyyy-MM-ddTHH:mm'"
                    (ngModelChange)="editedMeeting.endTime = $event"
                    title="Set meeting end date and time"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Meeting Participants -->
        <div class="bg-white rounded-lg shadow-sm border transition-all duration-200"
             [ngClass]="isEditing ? 'border-blue-400 ring-2 ring-blue-100' : 'border-gray-200'">
          <!-- Card Header -->
          <div class="flex items-center justify-between px-4 py-3 border-b"
               [ngClass]="isEditing ? 'border-blue-300 bg-blue-50/50' : 'border-gray-200'">
            <h3 class="text-base font-semibold text-gray-900">Meeting Participants ({{ allParticipants.length }} total)</h3>
            <div class="flex items-center space-x-2">
              <!-- Collapse/Expand button -->
              <button 
                type="button"
                (click)="toggleCardCollapse('participants')"
                class="p-1 text-gray-400 hover:text-gray-600 transition-colors">
                <mat-icon class="w-4 h-4">{{ cardState.participants.collapsed ? 'expand_more' : 'expand_less' }}</mat-icon>
              </button>
            </div>
          </div>
          
          <div class="p-4" [hidden]="cardState.participants.collapsed">
            <!-- Participant Edit Mode -->
            <div *ngIf="isEditing" class="space-y-4">
              
              <!-- Add Participant Button -->
              <div class="flex items-center justify-between">
                <h4 class="text-sm font-medium text-gray-900">Manage Participants</h4>
                <button 
                  *ngIf="!isAddingParticipant"
                  type="button"
                  (click)="isAddingParticipant = true"
                  class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-100 border border-transparent rounded-md hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                  <mat-icon class="w-4 h-4 mr-1">add</mat-icon>
                  Add Participant
                </button>
              </div>

              <!-- Add Participant Form -->
              <div *ngIf="isAddingParticipant" class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h5 class="text-sm font-medium text-gray-900 mb-3">Add New Participant</h5>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="participant-name" class="block text-xs font-medium text-gray-700 mb-1">Name *</label>
                    <input 
                      id="participant-name"
                      type="text" 
                      [(ngModel)]="newParticipant.name"
                      placeholder="Enter participant name"
                      class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  <div>
                    <label for="participant-email" class="block text-xs font-medium text-gray-700 mb-1">Email *</label>
                    <input 
                      id="participant-email"
                      type="email" 
                      [(ngModel)]="newParticipant.email"
                      placeholder="Enter email address"
                      class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  <div>
                    <label for="participant-type" class="block text-xs font-medium text-gray-700 mb-1">Type</label>
                    <select 
                      id="participant-type"
                      title="Select participant type"
                      [(ngModel)]="newParticipant.type"
                      class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                      <option value="CLIENT">Client</option>
                      <option value="G37">G37 Team</option>
                      <option value="OTHER">Other</option>
                    </select>
                  </div>
                  <div>
                    <label for="participant-role" class="block text-xs font-medium text-gray-700 mb-1">Role</label>
                    <select 
                      id="participant-role"
                      title="Select participant role"
                      [(ngModel)]="newParticipant.role"
                      class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                      <option value="ATTENDEE">Attendee</option>
                      <option value="ORGANIZER">Organizer</option>
                      <option value="PRESENTER">Presenter</option>
                      <option value="OBSERVER">Observer</option>
                      <option value="ACTION_OWNER">Action Owner</option>
                    </select>
                  </div>
                </div>
                <div class="flex items-center mt-3">
                  <input 
                    type="checkbox" 
                    id="required-participant"
                    [(ngModel)]="newParticipant.isRequired"
                    class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                  <label for="required-participant" class="text-xs text-gray-700">Required participant</label>
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                  <button 
                    type="button"
                    (click)="cancelAddParticipant()"
                    class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Cancel
                  </button>
                  <button 
                    type="button"
                    (click)="handleAddParticipant()"
                    [disabled]="!newParticipant.name?.trim() || !newParticipant.email?.trim()"
                    class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Add Participant
                  </button>
                </div>
              </div>

              <!-- Editable Participant List -->
              <div class="space-y-3">
                
                <!-- Client Participants -->
                <div>
                  <div class="flex items-center mb-2">
                    <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                    <h4 class="text-sm font-medium text-gray-900">Client Participants ({{ getParticipantsByType(ParticipantType.CLIENT).length }})</h4>
                    <span class="ml-auto text-xs text-gray-500">{{ getAttendanceStats(ParticipantType.CLIENT).attended }} attended ‚Ä¢ {{ getAttendanceStats(ParticipantType.CLIENT).absent }} absent</span>
                  </div>
                  <div class="ml-5 space-y-1">
                    <div *ngFor="let participant of getParticipantsByType(ParticipantType.CLIENT)" class="space-y-2">
                      <!-- Display Mode -->
                      <div *ngIf="!isEditingParticipant(participant.id)" class="flex items-center justify-between py-2 px-3 bg-white border border-gray-200 rounded-md">
                        <div class="flex items-center space-x-3">
                          <div class="flex flex-col">
                            <span class="text-sm text-gray-800 font-medium">{{ participant.name }}</span>
                            <span class="text-xs text-gray-500">{{ participant.email }}</span>
                          </div>
                          <span class="text-xs px-2 py-1 rounded-full" 
                                [ngClass]="{
                                  'bg-blue-100 text-blue-800': participant.role !== 'ACTION_OWNER',
                                  'bg-purple-100 text-purple-800': participant.role === 'ACTION_OWNER'
                                }">{{ participant.role }}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                          <button 
                            type="button"
                            (click)="toggleParticipantAttendance(participant)"
                            class="text-xs px-2 py-1 rounded-full border"
                            [ngClass]="participant.attended ? 'bg-green-100 text-green-800 border-green-300' : 'bg-red-100 text-red-800 border-red-300'">
                            {{ participant.attended ? 'Present' : 'Absent' }}
                          </button>
                          <button 
                            type="button"
                            (click)="editParticipant(participant)"
                            class="text-blue-600 hover:text-blue-800 p-1">
                            <mat-icon class="w-4 h-4">edit</mat-icon>
                          </button>
                          <button 
                            type="button"
                            (click)="removeParticipant(participant)"
                            class="text-red-600 hover:text-red-800 p-1">
                            <mat-icon class="w-4 h-4">delete</mat-icon>
                          </button>
                        </div>
                      </div>

                      <!-- Edit Mode -->
                      <div *ngIf="isEditingParticipant(participant.id)" class="py-3 px-3 bg-blue-50 border border-blue-200 rounded-md">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                          <div>
                            <label for="edit-name-{{participant.id}}" class="block text-xs font-medium text-gray-700 mb-1">Name</label>
                            <input
                              id="edit-name-{{participant.id}}"
                              type="text"
                              [(ngModel)]="editingParticipant.name"
                              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Participant name">
                          </div>
                          <div>
                            <label for="edit-email-{{participant.id}}" class="block text-xs font-medium text-gray-700 mb-1">Email</label>
                            <input
                              id="edit-email-{{participant.id}}"
                              type="email"
                              [(ngModel)]="editingParticipant.email"
                              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                              placeholder="email@example.com">
                          </div>
                          <div>
                            <label for="edit-role-{{participant.id}}" class="block text-xs font-medium text-gray-700 mb-1">Role</label>
                            <select
                              id="edit-role-{{participant.id}}"
                              [(ngModel)]="editingParticipant.role"
                              title="Select participant role"
                              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                              <option value="ORGANIZER">Organizer</option>
                              <option value="PRESENTER">Presenter</option>
                              <option value="ATTENDEE">Attendee</option>
                              <option value="OPTIONAL">Optional</option>
                              <option value="OBSERVER">Observer</option>
                              <option value="ACTION_OWNER">Action Owner</option>
                            </select>
                          </div>
                        </div>
                        <div class="flex justify-end space-x-2 mt-3">
                          <button
                            type="button"
                            (click)="cancelParticipantEdit()"
                            class="px-3 py-1 text-xs text-gray-600 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200">
                            Cancel
                          </button>
                          <button
                            type="button"
                            (click)="saveParticipantEdit()"
                            class="px-3 py-1 text-xs text-white bg-blue-600 border border-blue-600 rounded-md hover:bg-blue-700">
                            Save Changes
                          </button>
                        </div>
                      </div>
                    </div>
                    <div *ngIf="getParticipantsByType(ParticipantType.CLIENT).length === 0" class="ml-3 text-xs text-gray-500 italic">
                      No client participants added
                    </div>
                  </div>
                </div>

                <!-- G37 Team -->
                <div>
                  <div class="flex items-center mb-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                    <h4 class="text-sm font-medium text-gray-900">G37 Team ({{ getParticipantsByType(ParticipantType.G37).length }})</h4>
                    <span class="ml-auto text-xs text-gray-500">{{ getAttendanceStats(ParticipantType.G37).attended }} attended ‚Ä¢ {{ getAttendanceStats(ParticipantType.G37).absent }} absent</span>
                  </div>
                  <div class="ml-5 space-y-1">
                    <div *ngFor="let participant of getParticipantsByType(ParticipantType.G37)" class="space-y-2">
                      <!-- Display Mode -->
                      <div *ngIf="!isEditingParticipant(participant.id)" class="flex items-center justify-between py-2 px-3 bg-white border border-gray-200 rounded-md">
                        <div class="flex items-center space-x-3">
                          <div class="flex flex-col">
                            <span class="text-sm text-gray-800 font-medium">{{ participant.name }}</span>
                            <span class="text-xs text-gray-500">{{ participant.email }}</span>
                          </div>
                          <span class="text-xs px-2 py-1 rounded-full" 
                                [ngClass]="{
                                  'bg-green-100 text-green-800': participant.role !== 'ACTION_OWNER',
                                  'bg-purple-100 text-purple-800': participant.role === 'ACTION_OWNER'
                                }">{{ participant.role }}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                          <button 
                            type="button"
                            (click)="toggleParticipantAttendance(participant)"
                            class="text-xs px-2 py-1 rounded-full border"
                            [ngClass]="participant.attended ? 'bg-green-100 text-green-800 border-green-300' : 'bg-red-100 text-red-800 border-red-300'">
                            {{ participant.attended ? 'Present' : 'Absent' }}
                          </button>
                          <button 
                            type="button"
                            (click)="editParticipant(participant)"
                            class="text-blue-600 hover:text-blue-800 p-1">
                            <mat-icon class="w-4 h-4">edit</mat-icon>
                          </button>
                          <button 
                            type="button"
                            (click)="removeParticipant(participant)"
                            class="text-red-600 hover:text-red-800 p-1">
                            <mat-icon class="w-4 h-4">delete</mat-icon>
                          </button>
                        </div>
                      </div>

                      <!-- Edit Mode -->
                      <div *ngIf="isEditingParticipant(participant.id)" class="py-3 px-3 bg-green-50 border border-green-200 rounded-md">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                          <div>
                            <label for="edit-name-g37-{{participant.id}}" class="block text-xs font-medium text-gray-700 mb-1">Name</label>
                            <input
                              id="edit-name-g37-{{participant.id}}"
                              type="text"
                              [(ngModel)]="editingParticipant.name"
                              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                              placeholder="Participant name">
                          </div>
                          <div>
                            <label for="edit-email-g37-{{participant.id}}" class="block text-xs font-medium text-gray-700 mb-1">Email</label>
                            <input
                              id="edit-email-g37-{{participant.id}}"
                              type="email"
                              [(ngModel)]="editingParticipant.email"
                              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                              placeholder="email@example.com">
                          </div>
                          <div>
                            <label for="edit-role-g37-{{participant.id}}" class="block text-xs font-medium text-gray-700 mb-1">Role</label>
                            <select
                              id="edit-role-g37-{{participant.id}}"
                              [(ngModel)]="editingParticipant.role"
                              title="Select participant role"
                              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500">
                              <option value="ORGANIZER">Organizer</option>
                              <option value="PRESENTER">Presenter</option>
                              <option value="ATTENDEE">Attendee</option>
                              <option value="OPTIONAL">Optional</option>
                              <option value="OBSERVER">Observer</option>
                              <option value="ACTION_OWNER">Action Owner</option>
                            </select>
                          </div>
                        </div>
                        <div class="flex justify-end space-x-2 mt-3">
                          <button
                            type="button"
                            (click)="cancelParticipantEdit()"
                            class="px-3 py-1 text-xs text-gray-600 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200">
                            Cancel
                          </button>
                          <button
                            type="button"
                            (click)="saveParticipantEdit()"
                            class="px-3 py-1 text-xs text-white bg-green-600 border border-green-600 rounded-md hover:bg-green-700">
                            Save Changes
                          </button>
                        </div>
                      </div>
                    </div>
                    <div *ngIf="getParticipantsByType(ParticipantType.G37).length === 0" class="ml-3 text-xs text-gray-500 italic">
                      No G37 team members added
                    </div>
                  </div>
                </div>

                <!-- Other Participants -->
                <div>
                  <div class="flex items-center mb-2">
                    <div class="w-3 h-3 bg-orange-500 rounded-full mr-2"></div>
                    <h4 class="text-sm font-medium text-gray-900">Other Participants ({{ getParticipantsByType(ParticipantType.OTHER).length }})</h4>
                    <span class="ml-auto text-xs text-gray-500">{{ getAttendanceStats(ParticipantType.OTHER).attended }} attended ‚Ä¢ {{ getAttendanceStats(ParticipantType.OTHER).absent }} absent</span>
                  </div>
                  <div class="ml-5 space-y-1">
                    <div *ngFor="let participant of getParticipantsByType(ParticipantType.OTHER)" class="space-y-2">
                      <!-- Display Mode -->
                      <div *ngIf="!isEditingParticipant(participant.id)" class="flex items-center justify-between py-2 px-3 bg-white border border-gray-200 rounded-md">
                        <div class="flex items-center space-x-3">
                          <div class="flex flex-col">
                            <span class="text-sm text-gray-800 font-medium">{{ participant.name }}</span>
                            <span class="text-xs text-gray-500">{{ participant.email }}</span>
                          </div>
                          <span class="text-xs px-2 py-1 rounded-full" 
                                [ngClass]="{
                                  'bg-orange-100 text-orange-800': participant.role !== 'ACTION_OWNER',
                                  'bg-purple-100 text-purple-800': participant.role === 'ACTION_OWNER'
                                }">{{ participant.role }}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                          <button 
                            type="button"
                            (click)="toggleParticipantAttendance(participant)"
                            class="text-xs px-2 py-1 rounded-full border"
                            [ngClass]="participant.attended ? 'bg-green-100 text-green-800 border-green-300' : 'bg-red-100 text-red-800 border-red-300'">
                            {{ participant.attended ? 'Present' : 'Absent' }}
                          </button>
                          <button 
                            type="button"
                            (click)="editParticipant(participant)"
                            class="text-blue-600 hover:text-blue-800 p-1">
                            <mat-icon class="w-4 h-4">edit</mat-icon>
                          </button>
                          <button 
                            type="button"
                            (click)="removeParticipant(participant)"
                            class="text-red-600 hover:text-red-800 p-1">
                            <mat-icon class="w-4 h-4">delete</mat-icon>
                          </button>
                        </div>
                      </div>

                      <!-- Edit Mode -->
                      <div *ngIf="isEditingParticipant(participant.id)" class="py-3 px-3 bg-orange-50 border border-orange-200 rounded-md">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                          <div>
                            <label for="edit-name-other-{{participant.id}}" class="block text-xs font-medium text-gray-700 mb-1">Name</label>
                            <input
                              id="edit-name-other-{{participant.id}}"
                              type="text"
                              [(ngModel)]="editingParticipant.name"
                              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"
                              placeholder="Participant name">
                          </div>
                          <div>
                            <label for="edit-email-other-{{participant.id}}" class="block text-xs font-medium text-gray-700 mb-1">Email</label>
                            <input
                              id="edit-email-other-{{participant.id}}"
                              type="email"
                              [(ngModel)]="editingParticipant.email"
                              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"
                              placeholder="email@example.com">
                          </div>
                          <div>
                            <label for="edit-role-other-{{participant.id}}" class="block text-xs font-medium text-gray-700 mb-1">Role</label>
                            <select
                              id="edit-role-other-{{participant.id}}"
                              [(ngModel)]="editingParticipant.role"
                              title="Select participant role"
                              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                              <option value="ORGANIZER">Organizer</option>
                              <option value="PRESENTER">Presenter</option>
                              <option value="ATTENDEE">Attendee</option>
                              <option value="OPTIONAL">Optional</option>
                              <option value="OBSERVER">Observer</option>
                              <option value="ACTION_OWNER">Action Owner</option>
                            </select>
                          </div>
                        </div>
                        <div class="flex justify-end space-x-2 mt-3">
                          <button
                            type="button"
                            (click)="cancelParticipantEdit()"
                            class="px-3 py-1 text-xs text-gray-600 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200">
                            Cancel
                          </button>
                          <button
                            type="button"
                            (click)="saveParticipantEdit()"
                            class="px-3 py-1 text-xs text-white bg-orange-600 border border-orange-600 rounded-md hover:bg-orange-700">
                            Save Changes
                          </button>
                        </div>
                      </div>
                    </div>
                    <div *ngIf="getParticipantsByType(ParticipantType.OTHER).length === 0" class="ml-3 text-xs text-gray-500 italic">
                      No other participants added
                    </div>
                  </div>
                </div>

              </div>
            </div>

            <!-- Participant View Mode -->
            <div *ngIf="!isEditing" class="space-y-3">
              
              <!-- Client Participants -->
              <div>
                <div class="flex items-center mb-2">
                  <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                  <h4 class="text-sm font-medium text-gray-900">Client Participants ({{ getParticipantsByType(ParticipantType.CLIENT).length }})</h4>
                  <span class="ml-auto text-xs text-gray-500">{{ getAttendanceStats(ParticipantType.CLIENT).attended }} attended ‚Ä¢ {{ getAttendanceStats(ParticipantType.CLIENT).absent }} absent</span>
                </div>
                <div class="ml-5 space-y-1">
                  <div *ngFor="let participant of getParticipantsByType(ParticipantType.CLIENT)" class="flex items-center justify-between py-1">
                    <div class="flex items-center space-x-2 flex-wrap">
                      <span class="text-sm text-gray-800">{{ participant.name }}</span>

                      <!-- External Contact Badge -->
                      <span *ngIf="participant.isExternal"
                            class="text-xs px-2 py-0.5 rounded-full bg-orange-100 text-orange-800 border border-orange-300"
                            title="External contact - potential CRM match">
                        üåê External
                      </span>

                      <!-- CRM Linked Badge -->
                      <span *ngIf="participant.crmContactId"
                            class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800 border border-green-300"
                            [title]="'Linked to ' + (participant.crmSource || 'CRM')">
                        üîó {{ participant.crmSource || 'CRM' }}
                      </span>

                      <span *ngIf="participant.role === ParticipantRole.ORGANIZER" class="text-xs text-orange-600 font-medium">ORGANIZER</span>
                      <span *ngIf="participant.role === ParticipantRole.ACTION_OWNER" class="text-xs text-purple-600 font-medium">ACTION OWNER</span>
                    </div>
                    <span class="text-xs" [ngClass]="participant.attended ? 'text-green-600' : 'text-red-600'">
                      {{ participant.attended ? 'attended' : 'absent' }}
                    </span>
                  </div>
                  <div *ngIf="getParticipantsByType(ParticipantType.CLIENT).length === 0" class="ml-3 text-xs text-gray-500 italic">
                    No client participants
                  </div>
                </div>
              </div>

              <!-- G37 Team -->
              <div>
                <div class="flex items-center mb-2">
                  <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                  <h4 class="text-sm font-medium text-gray-900">G37 Team ({{ getParticipantsByType(ParticipantType.G37).length }})</h4>
                  <span class="ml-auto text-xs text-gray-500">{{ getAttendanceStats(ParticipantType.G37).attended }} attended ‚Ä¢ {{ getAttendanceStats(ParticipantType.G37).absent }} absent</span>
                </div>
                <div class="ml-5 space-y-1">
                  <div *ngFor="let participant of getParticipantsByType(ParticipantType.G37)" class="flex items-center justify-between py-1">
                    <div class="flex items-center space-x-2 flex-wrap">
                      <span class="text-sm text-gray-800">{{ participant.name }}</span>

                      <!-- External Contact Badge -->
                      <span *ngIf="participant.isExternal"
                            class="text-xs px-2 py-0.5 rounded-full bg-orange-100 text-orange-800 border border-orange-300"
                            title="External contact - potential CRM match">
                        üåê External
                      </span>

                      <!-- CRM Linked Badge -->
                      <span *ngIf="participant.crmContactId"
                            class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800 border border-green-300"
                            [title]="'Linked to ' + (participant.crmSource || 'CRM')">
                        üîó {{ participant.crmSource || 'CRM' }}
                      </span>

                      <span *ngIf="participant.role === ParticipantRole.ORGANIZER" class="text-xs text-orange-600 font-medium">ORGANIZER</span>
                      <span *ngIf="participant.role === ParticipantRole.ACTION_OWNER" class="text-xs text-purple-600 font-medium">ACTION OWNER</span>
                    </div>
                    <span class="text-xs" [ngClass]="participant.attended ? 'text-green-600' : 'text-red-600'">
                      {{ participant.attended ? 'attended' : 'absent' }}
                    </span>
                  </div>
                  <div *ngIf="getParticipantsByType(ParticipantType.G37).length === 0" class="ml-3 text-xs text-gray-500 italic">
                    No G37 team members
                  </div>
                </div>
              </div>

              <!-- Other Participants -->
              <div *ngIf="getParticipantsByType(ParticipantType.OTHER).length > 0">
                <div class="flex items-center mb-2">
                  <div class="w-3 h-3 bg-orange-500 rounded-full mr-2"></div>
                  <h4 class="text-sm font-medium text-gray-900">Other Participants ({{ getParticipantsByType(ParticipantType.OTHER).length }})</h4>
                  <span class="ml-auto text-xs text-gray-500">{{ getAttendanceStats(ParticipantType.OTHER).attended }} attended ‚Ä¢ {{ getAttendanceStats(ParticipantType.OTHER).absent }} absent</span>
                </div>
                <div class="ml-5 space-y-1">
                  <div *ngFor="let participant of getParticipantsByType(ParticipantType.OTHER)" class="flex items-center justify-between py-1">
                    <div class="flex items-center space-x-2 flex-wrap">
                      <span class="text-sm text-gray-800">{{ participant.name }}</span>

                      <!-- External Contact Badge -->
                      <span *ngIf="participant.isExternal"
                            class="text-xs px-2 py-0.5 rounded-full bg-orange-100 text-orange-800 border border-orange-300"
                            title="External contact - potential CRM match">
                        üåê External
                      </span>

                      <!-- CRM Linked Badge -->
                      <span *ngIf="participant.crmContactId"
                            class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800 border border-green-300"
                            [title]="'Linked to ' + (participant.crmSource || 'CRM')">
                        üîó {{ participant.crmSource || 'CRM' }}
                      </span>

                      <span *ngIf="participant.role === ParticipantRole.ORGANIZER" class="text-xs text-orange-600 font-medium">ORGANIZER</span>
                      <span *ngIf="participant.role === ParticipantRole.ACTION_OWNER" class="text-xs text-purple-600 font-medium">ACTION OWNER</span>
                    </div>
                    <span class="text-xs" [ngClass]="participant.attended ? 'text-green-600' : 'text-red-600'">
                      {{ participant.attended ? 'attended' : 'absent' }}
                    </span>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Meeting Overview -->
        <div class="bg-white rounded-lg shadow-sm border transition-all duration-200"
             [ngClass]="isEditing ? 'border-blue-400 ring-2 ring-blue-100' : 'border-gray-200'">
          <!-- Card Header -->
          <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
            <h3 class="text-base font-semibold text-gray-900">Meeting Overview</h3>
            <div class="flex items-center space-x-2">
              <!-- Edit button (visible when in global edit mode and not editing this card) -->
              <button 
                *ngIf="isEditing && !cardState.overview.editing"
                type="button"
                (click)="toggleCardEdit('overview')"
                class="px-2 py-1 text-xs bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-md transition-colors">
                Edit
              </button>
              <!-- Cancel button (only visible when editing this card) -->
              <button 
                *ngIf="cardState.overview.editing"
                type="button"
                (click)="toggleCardEdit('overview')"
                class="px-2 py-1 text-xs bg-red-100 text-red-700 hover:bg-red-200 rounded-md transition-colors">
                Cancel
              </button>
              <!-- Save button (only visible when editing this card) -->
              <button 
                *ngIf="cardState.overview.editing"
                type="button"
                (click)="saveCard('overview')"
                class="px-2 py-1 text-xs bg-green-100 text-green-700 hover:bg-green-200 rounded-md transition-colors">
                Save
              </button>
              <!-- Collapse/Expand button -->
              <button 
                type="button"
                (click)="toggleCardCollapse('overview')"
                class="p-1 text-gray-400 hover:text-gray-600 transition-colors">
                <mat-icon class="w-4 h-4">{{ cardState.overview.collapsed ? 'expand_more' : 'expand_less' }}</mat-icon>
              </button>
            </div>
          </div>
          
          <div class="p-4 space-y-4" [hidden]="cardState.overview.collapsed">
            <!-- Summary -->
            <div class="border-l-4 border-blue-500 pl-4">
              <h4 class="text-sm font-medium text-gray-900 mb-1">Summary</h4>
              <!-- Read-only view -->
              <div *ngIf="!cardState.overview.editing">
                <p class="text-sm text-gray-700" *ngIf="editedMeeting.summary; else noSummary">{{ editedMeeting.summary }}</p>
                <ng-template #noSummary>
                  <p class="text-sm text-gray-400 italic">Sprint retrospective</p>
                </ng-template>
              </div>
              <!-- Edit view -->
              <textarea 
                *ngIf="cardState.overview.editing"
                [(ngModel)]="editedMeeting.summary"
                placeholder="Enter meeting summary..."
                rows="3"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </textarea>
            </div>
            
            <!-- Details -->
            <div class="border-l-4 border-green-500 pl-4">
              <h4 class="text-sm font-medium text-gray-900 mb-1">Details</h4>
              <!-- Read-only view -->
              <div *ngIf="!cardState.overview.editing">
                <p class="text-sm text-gray-700" *ngIf="editedMeeting.details; else noDetails">{{ editedMeeting.details }}</p>
                <ng-template #noDetails>
                  <div class="text-sm text-gray-400 italic space-y-1">
                    <p>Analyzed sprint outcomes and blockers</p>
                  </div>
                </ng-template>
              </div>
              <!-- Edit view -->
              <textarea 
                *ngIf="cardState.overview.editing"
                [(ngModel)]="editedMeeting.details"
                placeholder="Enter meeting details..."
                rows="4"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </textarea>
            </div>
            
            <!-- Next Steps -->
            <div class="border-l-4 border-purple-500 pl-4">
              <h4 class="text-sm font-medium text-gray-900 mb-1">Next Steps</h4>
              <!-- Read-only view -->
              <div *ngIf="!cardState.overview.editing">
                <p class="text-sm text-gray-700" *ngIf="editedMeeting.nextSteps; else noNextSteps">{{ editedMeeting.nextSteps }}</p>
                <ng-template #noNextSteps>
                  <div class="text-sm text-gray-400 italic space-y-1">
                    <p>Schedule follow-up</p>
                  </div>
                </ng-template>
              </div>
              <!-- Edit view -->
              <textarea 
                *ngIf="cardState.overview.editing"
                [(ngModel)]="editedMeeting.nextSteps"
                placeholder="Enter next steps..."
                rows="3"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </textarea>
            </div>
          </div>
        </div>

        <!-- Fathom Recording & Transcript Card -->
        <div *ngIf="isFathomMeeting()"
             class="bg-white rounded-lg shadow-sm border border-gray-200">
          <!-- Card Header -->
          <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
            <h3 class="text-base font-semibold text-gray-900 flex items-center">
              <span class="mr-2">üé§</span>
              Fathom Recording
            </h3>
            <div class="flex items-center space-x-2">
              <button
                type="button"
                (click)="toggleCardCollapse('recording')"
                class="p-1 text-gray-400 hover:text-gray-600 transition-colors">
                <mat-icon class="w-4 h-4">{{ cardState.recording?.collapsed ? 'expand_more' : 'expand_less' }}</mat-icon>
              </button>
            </div>
          </div>

          <div class="p-4" [hidden]="cardState.recording?.collapsed">
            <!-- Recording Link -->
            <div *ngIf="getFathomRecordingUrl()" class="mb-4">
              <a [href]="getFathomRecordingUrl()!"
                 target="_blank"
                 rel="noopener noreferrer"
                 class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
                <mat-icon class="w-5 h-5 mr-2">play_circle</mat-icon>
                Open Fathom Recording
              </a>
            </div>

            <!-- Fathom Summary -->
            <div *ngIf="meeting.fathomSummary" class="mb-4">
              <h4 class="text-sm font-medium text-gray-900 mb-2 flex items-center">
                <mat-icon class="w-4 h-4 mr-1">auto_awesome</mat-icon>
                AI Summary from Fathom
              </h4>
              <p class="text-sm text-gray-700 bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                {{ meeting.fathomSummary }}
              </p>
            </div>

            <!-- Transcript Preview -->
            <div *ngIf="meeting.transcript || meeting.transcriptEntries" class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
              <h4 class="text-sm font-medium text-gray-900 mb-3 flex items-center">
                <mat-icon class="w-4 h-4 mr-1">transcribe</mat-icon>
                Transcript
              </h4>

              <!-- Structured transcript entries -->
              <div *ngIf="meeting.transcriptEntries && meeting.transcriptEntries.length > 0" class="space-y-2 text-sm">
                <div *ngFor="let entry of meeting.transcriptEntries"
                     class="border-l-2 border-gray-300 pl-3 py-1 hover:bg-gray-100 rounded transition-colors">
                  <div class="flex items-center space-x-2 mb-1">
                    <span class="font-medium text-gray-700">{{ entry.speaker }}</span>
                    <span class="text-xs text-gray-500">{{ formatTranscriptTimestamp(entry.timestamp) }}</span>
                  </div>
                  <p class="text-gray-600">{{ entry.text }}</p>
                </div>
              </div>

              <!-- Plain text transcript fallback -->
              <div *ngIf="meeting.transcript && (!meeting.transcriptEntries || meeting.transcriptEntries.length === 0)" class="text-sm text-gray-700 whitespace-pre-wrap">
                {{ meeting.transcript }}
              </div>

              <div *ngIf="!meeting.transcript && (!meeting.transcriptEntries || meeting.transcriptEntries.length === 0)" class="text-sm text-gray-500 italic text-center py-4">
                No transcript available for this recording
              </div>
            </div>

            <!-- No recording available message -->
            <div *ngIf="!getFathomRecordingUrl() && !meeting.fathomSummary && !meeting.transcript" class="text-center py-6">
              <mat-icon class="w-8 h-8 text-gray-400 mx-auto mb-2">mic_off</mat-icon>
              <p class="text-sm text-gray-500">Recording data not available</p>
            </div>
          </div>
        </div>

        <!-- Unified Actions (replaces Pending Actions + Action Items) -->
        <app-unified-actions
          [meeting]="editedMeeting"
          (actionChanged)="loadMeeting()">
        </app-unified-actions>

        <!-- AI Suggestions Section (moved from sidebar) -->
        <app-meeting-intelligence-panel
          [meeting]="editedMeeting"
          [showOnlyAISuggestions]="true"
          (actionItemAdded)="handleSuggestedActionItem($event)">
        </app-meeting-intelligence-panel>

      </div>

      <!-- Sidebar -->
      <div class="md:w-1/3 w-full flex-shrink-0">
        <app-meeting-intelligence-panel
          [meeting]="editedMeeting"
          [hideAISuggestions]="true"
          (actionItemAdded)="handleSuggestedActionItem($event)"
          (followUpScheduled)="handleFollowUpScheduled()">
        </app-meeting-intelligence-panel>
      </div>

    </div>
  </div>
</div>